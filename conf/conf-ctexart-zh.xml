<?xml version="1.0" encoding="UTF-8"?>
<set xmlns="http://transpect.io/xml2tex"
     xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
     xmlns:tr="http://transpect.io">

  <!-- Import the default docx2tex configuration, then override selectively below -->
  <import href="conf.xml"/>

  <!-- Preamble: switch to ctexart, drop babel/inputenc/fontenc from default -->
  <preamble>
    % Customized for Chinese documents
    \documentclass[UTF8]{ctexart}
    \usepackage[british,english]{babel}
    \usepackage{graphicx}
    \usepackage{hyperref}
    \usepackage{multirow}
    \usepackage{tabularx}
    \usepackage{color}
    \usepackage{textcomp}
    \usepackage{amsmath}
    \usepackage{amssymb}
    \usepackage{amsfonts}
    \usepackage{amsxtra}
    \usepackage{wasysym}
    \usepackage{isomath}
    \usepackage{mathtools}
    \usepackage{upgreek}
    \usepackage{enumerate}
    \usepackage{tensor}
    \usepackage{pifont}
    \usepackage{ulem}
    \usepackage{xfrac}
    \usepackage{arydshln}
  </preamble>

  <!-- Namespaces used in contexts -->
  <ns prefix="dbk" uri="http://docbook.org/ns/docbook"/>
  <ns prefix="html" uri="http://www.w3.org/1999/xhtml"/>
  <ns prefix="css"  uri="http://www.w3.org/1996/css"/>
  <ns prefix="svg"  uri="http://www.w3.org/2000/svg"/>
  <ns prefix="docx2tex" uri="http://transpect.io/docx2tex"/>
  <ns prefix="mml2tex" uri="http://transpect.io/mml2tex"/>
  <ns prefix="tr"   uri="http://transpect.io"/>

  <!-- Title -> \\title -->
  <template context="dbk:para[@role = ('title','Title','Titel','titel')]"><rule break-after="2" name="title" type="cmd">
      <param/>
    </rule>
  </template>

  <!-- Headline mappings for article class (Heading1->\section, etc.) -->

  <!-- Special case: unnumbered top-level heading for 参考文献 -->
  <template context="dbk:para[@role = ('berschrift1','headline1','heading1','Heading1')]
                             [contains(normalize-space(string-join(.//text(), '')), '参考文献')]">
    <rule break-after="2" name="section*" type="cmd">
      <param/>
    </rule>
  </template>

  <!-- General Heading1 -> \section -->
  <template context="dbk:para[@role = ('berschrift1','headline1','heading1','Heading1')]">
    <rule break-after="2" name="section" type="cmd">
      <param/>
    </rule>
  </template>

  <!-- Heading2 -> \subsection -->
  <template context="dbk:para[@role = ('berschrift2','headline2','heading2','Heading2')]">
    <rule break-after="2" name="subsection" type="cmd">
      <param/>
    </rule>
  </template>

  <!-- Heading3 -> \subsubsection -->
  <template context="dbk:para[@role = ('berschrift3','headline3','heading3','Heading3')]">
    <rule break-after="2" name="subsubsection" type="cmd">
      <param/>
    </rule>
  </template>

  <!-- Heading4 -> \paragraph -->
  <template context="dbk:para[@role = ('berschrift4','headline4','heading4','Heading4')]">
    <rule break-after="2" name="paragraph" type="cmd">
      <param/>
    </rule>
  </template>

  <!-- Image sizing: prefer source CSS width/height; fallback to default behavior -->

  <!-- Use exact width/height from Hub when present -->
  <template context="dbk:imagedata[@fileref][@css:width or @css:height]">
    <rule name="includegraphics" type="cmd">
      <option select="if (@css:width) then concat('width=', @css:width)
                                   else concat('height=', @css:height)"/>
      <param select="replace(@fileref, '([%#])', '\\$1')"/>
    </rule>
  </template>

  <!-- Fallback: if no explicit size, use 1\textwidth or split width for multi-images -->
  <template context="dbk:imagedata[@fileref][not(@css:width) and not(@css:height)]">
    <rule name="includegraphics" type="cmd">
      <option select="concat('width=', 
                             if(ancestor::dbk:figure)
                             then 1 div count(ancestor::dbk:figure[last()]//*[local-name() = ('mediaobject', 'inlinemediaobject')])
                             else 1,
                             '\\textwidth')"/>
      <param select="replace(@fileref, '([%#])', '\\$1')"/>
    </rule>
  </template>

</set>
